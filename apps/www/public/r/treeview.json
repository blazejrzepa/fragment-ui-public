{
  "name": "treeview",
  "type": "registry:component",
  "dependencies": [
    "react",
    "react-dom",
    "@fragment_ui/ui"
  ],
  "files": [
    {
      "path": "components/ui/TreeView.tsx",
      "content": "\"use client\";\n\nimport * as React from \"react\";\nimport { Checkbox } from \"./checkbox\";\nimport clsx from \"clsx\";\nimport { ChevronRight, Folder, File, FolderOpen } from \"lucide-react\";\n\nexport interface TreeNode {\n  id: string;\n  label: string | React.ReactNode;\n  children?: TreeNode[];\n  icon?: React.ReactNode | ((isSelected: boolean) => React.ReactNode);\n  disabled?: boolean;\n  data?: Record<string, any>;\n  className?: string;\n  alwaysExpanded?: boolean;\n  hideChevron?: boolean;\n}\n\nexport interface TreeViewProps {\n  nodes?: TreeNode[];\n  selectedIds?: string[];\n  renderNodeActions?: (node: TreeNode) => React.ReactNode;\n  expandedIds?: string[];\n  onSelectionChange?: (selectedIds: string[]) => void;\n  onExpansionChange?: (expandedIds: string[]) => void;\n  onNodeClick?: (node: TreeNode) => void;\n  onNodeDoubleClick?: (node: TreeNode) => void;\n  showCheckboxes?: boolean;\n  showIcons?: boolean;\n  defaultExpanded?: boolean;\n  className?: string;\n  indentSize?: number;\n}\n\nfunction TreeNodeComponent({\n  node,\n  level = 0,\n  selectedIds = [],\n  expandedIds = [],\n  onSelectionChange,\n  onExpansionChange,\n  onNodeClick,\n  onNodeDoubleClick,\n  showCheckboxes = false,\n  showIcons = true,\n  defaultExpanded = false,\n  indentSize = 20,\n  renderNodeActions,\n}: {\n  node: TreeNode;\n  level?: number;\n  selectedIds: string[];\n  expandedIds: string[];\n  onSelectionChange?: (selectedIds: string[]) => void;\n  onExpansionChange?: (expandedIds: string[]) => void;\n  onNodeClick?: (node: TreeNode) => void;\n  onNodeDoubleClick?: (node: TreeNode) => void;\n  showCheckboxes?: boolean;\n  showIcons?: boolean;\n  defaultExpanded?: boolean;\n  indentSize?: number;\n  renderNodeActions?: (node: TreeNode) => React.ReactNode;\n}) {\n  const hasChildren = node.children && node.children.length > 0;\n  const isExpanded = node.alwaysExpanded || expandedIds.includes(node.id);\n  const isSelected = selectedIds.includes(node.id);\n  const shouldShowChevron = hasChildren && !node.hideChevron;\n  const isIndeterminate = React.useMemo(() => {\n    if (!hasChildren || !showCheckboxes) return false;\n    const childIds = getAllChildIds(node);\n    const selectedChildren = childIds.filter((id) => selectedIds.includes(id));\n    return selectedChildren.length > 0 && selectedChildren.length < childIds.length;\n  }, [node, selectedIds, hasChildren, showCheckboxes]);\n\n  const handleToggle = React.useCallback(() => {\n    if (node.disabled) return;\n    if (onExpansionChange) {\n      if (isExpanded) {\n        onExpansionChange(expandedIds.filter((id) => id !== node.id));\n      } else {\n        onExpansionChange([...expandedIds, node.id]);\n      }\n    } else {\n      // Uncontrolled mode - use internal state\n      // This is handled by the parent TreeView component\n    }\n  }, [node, isExpanded, expandedIds, onExpansionChange]);\n\n  const handleCheckboxChange = React.useCallback((checked: boolean) => {\n    if (node.disabled || !onSelectionChange) return;\n    const childIds = getAllChildIds(node);\n    if (checked) {\n      // Select this node and all children\n      const newSelected = [...new Set([...selectedIds, node.id, ...childIds])];\n      onSelectionChange(newSelected);\n    } else {\n      // Deselect this node and all children\n      const newSelected = selectedIds.filter((id) => id !== node.id && !childIds.includes(id));\n      onSelectionChange(newSelected);\n    }\n  }, [node, selectedIds, onSelectionChange]);\n\n  const handleNodeClick = React.useCallback(() => {\n    if (node.disabled) return;\n    onNodeClick?.(node);\n    if (hasChildren) {\n      handleToggle();\n    }\n  }, [node, hasChildren, handleToggle, onNodeClick]);\n\n  const handleNodeDoubleClick = React.useCallback(() => {\n    if (node.disabled) return;\n    onNodeDoubleClick?.(node);\n  }, [node, onNodeDoubleClick]);\n\n  const defaultIcon = hasChildren ? (\n    isExpanded ? <FolderOpen className=\"h-4 w-4\" /> : <Folder className=\"h-4 w-4\" />\n  ) : (\n    <File className=\"h-4 w-4\" />\n  );\n\n  return (\n    <div className={clsx(\"tree-node\", node.className)} data-node-id={node.id} role=\"treeitem\" aria-expanded={hasChildren ? isExpanded : undefined} aria-selected={isSelected}>\n      <div\n        className={clsx(\n          \"group flex items-center gap-2 py-1 px-2 rounded-[var(--radius-sm)]\",\n          \"hover:bg-[color:var(--color-surface-2)]\",\n          \"cursor-pointer select-none\",\n          isSelected && \"bg-[color:var(--color-surface-2)]\",\n          node.disabled && \"opacity-50 cursor-not-allowed\"\n        )}\n        style={{ \n          paddingLeft: level === 0 && node.hideChevron \n            ? `0px` // Projects root: no padding\n            : level === 0 && node.data?.isProjectsRoot\n            ? `0px` // Projects root without hideChevron - no padding\n            : `${level * indentSize + 8}px` \n        }}\n        draggable={!!node.data?.onDragStart}\n        onClick={handleNodeClick}\n        onDoubleClick={handleNodeDoubleClick}\n        onContextMenu={node.data?.onContextMenu}\n        onDragStart={node.data?.onDragStart}\n        onDragEnd={node.data?.onDragEnd}\n        onDragOver={node.data?.onDragOver}\n        onDragLeave={node.data?.onDragLeave}\n        onDrop={node.data?.onDrop}\n      >\n        {showCheckboxes && (\n          <div className=\"relative\">\n            <Checkbox\n              checked={isSelected || isIndeterminate}\n              onCheckedChange={handleCheckboxChange}\n              onClick={(e) => e.stopPropagation()}\n              disabled={node.disabled}\n              className={clsx(isIndeterminate && \"data-[state=checked]:bg-brand/50\")}\n            />\n            {isIndeterminate && (\n              <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n                <div className=\"w-2 h-0.5 bg-white\" />\n              </div>\n            )}\n          </div>\n        )}\n        {shouldShowChevron ? (\n          <button\n            type=\"button\"\n            className=\"flex items-center justify-center w-4 h-4 p-0 hover:bg-transparent\"\n            onClick={(e) => {\n              e.stopPropagation();\n              if (!node.alwaysExpanded) {\n                handleToggle();\n              }\n            }}\n            aria-label={isExpanded ? `Collapse ${node.label}` : `Expand ${node.label}`}\n            aria-expanded={isExpanded}\n            aria-controls={`tree-node-${node.id}`}\n            disabled={node.alwaysExpanded}\n            style={{ opacity: node.alwaysExpanded ? 0 : 1 }}\n          >\n            <ChevronRight\n              className={clsx(\n                \"h-4 w-4 transition-transform duration-200\",\n                isExpanded && \"rotate-90\"\n              )}\n            />\n          </button>\n        ) : null}\n        {showIcons && (\n          <div className=\"flex-shrink-0\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'flex-start', width: 'auto', height: 'auto' }}>\n            {typeof node.icon === 'function' \n              ? node.icon(isSelected) \n              : (node.icon || defaultIcon)}\n          </div>\n        )}\n        <span className={clsx(\n          \"flex-1 text-sm truncate whitespace-nowrap overflow-hidden\",\n          isSelected ? \"text-[color:var(--foreground-primary)]\" : \"text-[color:var(--foreground-secondary)]\"\n        )}>{node.label}</span>\n        {renderNodeActions && (() => {\n          const actions = renderNodeActions(node);\n          if (!actions) return null;\n          return (\n            <div className=\"tree-node-actions opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 ml-2\" style={{ minWidth: '24px' }}>\n              {actions}\n            </div>\n          );\n        })()}\n      </div>\n      {hasChildren && isExpanded && (\n        <div\n          id={`tree-node-${node.id}`}\n          role=\"group\"\n          className=\"tree-node-children\"\n        >\n          {node.children!.map((child) => (\n            <TreeNodeComponent\n              key={child.id}\n              node={child}\n              level={level + 1}\n              selectedIds={selectedIds}\n              expandedIds={expandedIds}\n              onSelectionChange={onSelectionChange}\n              onExpansionChange={onExpansionChange}\n              onNodeClick={onNodeClick}\n              onNodeDoubleClick={onNodeDoubleClick}\n              showCheckboxes={showCheckboxes}\n              showIcons={showIcons}\n              defaultExpanded={defaultExpanded}\n              indentSize={indentSize}\n              renderNodeActions={renderNodeActions}\n            />\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction getAllChildIds(node: TreeNode): string[] {\n  const ids: string[] = [];\n  if (node.children) {\n    node.children.forEach((child) => {\n      ids.push(child.id);\n      ids.push(...getAllChildIds(child));\n    });\n  }\n  return ids;\n}\n\nexport const TreeView = React.forwardRef<HTMLDivElement, TreeViewProps>(\n  function TreeView(\n    {\n      nodes,\n      selectedIds = [],\n      expandedIds,\n      onSelectionChange,\n      onExpansionChange,\n      onNodeClick,\n      onNodeDoubleClick,\n      showCheckboxes = false,\n      showIcons = true,\n      defaultExpanded = false,\n      className,\n      indentSize = 20,\n      renderNodeActions,\n    },\n    ref\n  ) {\n    // Ensure nodes is always an array\n    const safeNodes = React.useMemo(() => {\n      if (!nodes || !Array.isArray(nodes)) {\n        return [];\n      }\n      return nodes;\n    }, [nodes]);\n\n    // Track if expandedIds was explicitly passed as a prop\n    const expandedIdsRef = React.useRef(expandedIds);\n    React.useEffect(() => {\n      expandedIdsRef.current = expandedIds;\n    }, [expandedIds]);\n    const wasExpandedIdsProvided = expandedIdsRef.current !== undefined;\n    \n    // Initialize with defaultExpanded if no expandedIds provided\n    const initialExpandedIds = React.useMemo(() => {\n      if (wasExpandedIdsProvided && expandedIds && expandedIds.length > 0) return expandedIds;\n      if (defaultExpanded) {\n        // Get all node IDs recursively\n        const getAllNodeIds = (nodes: TreeNode[]): string[] => {\n          const ids: string[] = [];\n          nodes.forEach(node => {\n            ids.push(node.id);\n            if (node.children) {\n              ids.push(...getAllNodeIds(node.children));\n            }\n          });\n          return ids;\n        };\n        return getAllNodeIds(safeNodes);\n      }\n      return [];\n    }, [safeNodes, defaultExpanded, wasExpandedIdsProvided, expandedIds]);\n\n    // Use controlled or uncontrolled mode based on whether expandedIds or onExpansionChange is provided\n    // If expandedIds prop was explicitly provided, it's controlled (even without onExpansionChange)\n    // If onExpansionChange is provided, it's also controlled\n    const isControlled = wasExpandedIdsProvided || onExpansionChange !== undefined;\n    const [internalExpandedIds, setInternalExpandedIds] = React.useState<string[]>(initialExpandedIds);\n    const [internalSelectedIds, setInternalSelectedIds] = React.useState<string[]>(selectedIds);\n\n    // For controlled mode, use expandedIds directly; for uncontrolled, use internal state\n    const effectiveExpandedIds = isControlled ? (expandedIds ?? []) : internalExpandedIds;\n    const effectiveSelectedIds = selectedIds;\n    \n    // Sync expandedIds with internal state when controlled (for rerenders)\n    const prevExpandedIdsRef = React.useRef<string>(JSON.stringify(expandedIds || []));\n    \n    React.useEffect(() => {\n      if (isControlled && expandedIds !== undefined) {\n        const prevIds = prevExpandedIdsRef.current;\n        const newIds = JSON.stringify(expandedIds);\n        \n        // Only update if the arrays are actually different\n        if (prevIds !== newIds) {\n          setInternalExpandedIds(expandedIds);\n          prevExpandedIdsRef.current = newIds;\n        }\n      }\n    }, [expandedIds, isControlled]);\n\n    // Sync selectedIds with internal state (always needed for rendering)\n    const prevSelectedIdsRef = React.useRef<string>(JSON.stringify(selectedIds));\n    \n    React.useEffect(() => {\n      const prevIds = prevSelectedIdsRef.current;\n      const newIds = JSON.stringify(selectedIds);\n      \n      // Only update if the arrays are actually different\n      if (prevIds !== newIds) {\n        setInternalSelectedIds(selectedIds);\n        prevSelectedIdsRef.current = newIds;\n      }\n    }, [selectedIds]);\n\n    const handleExpansionChange = React.useCallback(\n      (newExpandedIds: string[]) => {\n        if (isControlled && onExpansionChange) {\n          // In controlled mode with handler, just call the parent handler\n          // Don't update internal state - let the parent control it\n          onExpansionChange(newExpandedIds);\n        } else if (!isControlled) {\n          // In uncontrolled mode, update internal state\n          setInternalExpandedIds(newExpandedIds);\n        }\n        // If controlled but no handler (expandedIds provided but no onExpansionChange),\n        // do nothing - parent controls via expandedIds prop\n      },\n      [onExpansionChange, isControlled]\n    );\n\n    const handleSelectionChange = React.useCallback(\n      (newSelectedIds: string[]) => {\n        setInternalSelectedIds(newSelectedIds);\n        onSelectionChange?.(newSelectedIds);\n      },\n      [onSelectionChange]\n    );\n\n    return (\n      <div\n        ref={ref}\n        className={clsx(\n          \"tree-view w-full border border-[color:var(--color-border)] rounded-[var(--radius-md)] p-2\",\n          \"bg-[color:var(--color-surface-1)]\",\n          className\n        )}\n        role=\"tree\"\n        aria-label=\"Tree view\"\n      >\n        {safeNodes.map((node) => (\n          <TreeNodeComponent\n            key={node.id}\n            node={node}\n            level={0}\n            selectedIds={effectiveSelectedIds}\n            expandedIds={effectiveExpandedIds}\n            onSelectionChange={handleSelectionChange}\n            onExpansionChange={handleExpansionChange}\n            onNodeClick={onNodeClick}\n            onNodeDoubleClick={onNodeDoubleClick}\n            showCheckboxes={showCheckboxes}\n            showIcons={showIcons}\n            defaultExpanded={defaultExpanded}\n            indentSize={indentSize}\n            renderNodeActions={renderNodeActions}\n          />\n        ))}\n      </div>\n    );\n  }\n);\n\nTreeView.displayName = \"TreeView\";\n\n"
    }
  ]
}