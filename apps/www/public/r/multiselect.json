{
  "name": "multiselect",
  "type": "registry:component",
  "dependencies": [
    "react",
    "react-dom",
    "@fragment_ui/ui"
  ],
  "files": [
    {
      "path": "components/ui/MultiSelect.tsx",
      "content": "\"use client\";\n\nimport * as React from \"react\";\nimport { Command as CommandPrimitive } from \"cmdk\";\nimport clsx from \"clsx\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./popover\";\nimport { Button } from \"./button\";\nimport { Spinner } from \"./spinner\";\nimport { X } from \"lucide-react\";\n\nexport interface MultiSelectOption {\n  value: string;\n  label: string;\n  disabled?: boolean;\n}\n\nexport interface MultiSelectProps {\n  options?: MultiSelectOption[];\n  value?: string[];\n  onValueChange?: (value: string[]) => void;\n  placeholder?: string;\n  searchPlaceholder?: string;\n  emptyText?: string;\n  maxCount?: number; // Max number of selected items to show before \"+X more\"\n  className?: string;\n  disabled?: boolean;\n  clearable?: boolean;\n  loading?: boolean; // Loading state\n  asyncOptions?: boolean; // If true, options can be loaded asynchronously\n}\n\nexport const MultiSelect = React.forwardRef<HTMLButtonElement, MultiSelectProps>(\n  function MultiSelect(\n    {\n      options,\n      value = [],\n      onValueChange,\n      placeholder = \"Select options...\",\n      searchPlaceholder = \"Search...\",\n      emptyText = \"No results found.\",\n      maxCount = 3,\n      className,\n      disabled,\n      clearable = true,\n      loading = false,\n      asyncOptions = false,\n    },\n    ref\n  ) {\n    const [open, setOpen] = React.useState(false);\n    const [search, setSearch] = React.useState(\"\");\n\n    // Ensure options is always an array\n    const safeOptions = React.useMemo(() => {\n      if (!options || !Array.isArray(options)) {\n        return [];\n      }\n      return options;\n    }, [options]);\n\n    const selectedOptions = React.useMemo(\n      () => safeOptions.filter((opt) => value.includes(opt.value)),\n      [safeOptions, value]\n    );\n\n    const filteredOptions = React.useMemo(() => {\n      if (!search) return safeOptions;\n      return safeOptions.filter((option) =>\n        option.label.toLowerCase().includes(search.toLowerCase())\n      );\n    }, [safeOptions, search]);\n\n    const handleSelect = React.useCallback((optionValue: string) => {\n      const newValue = value.includes(optionValue)\n        ? value.filter((v) => v !== optionValue)\n        : [...value, optionValue];\n      onValueChange?.(newValue);\n      // Keep popover open for multi-select\n      // Don't call setOpen(false) here\n    }, [value, onValueChange]);\n\n    const handleRemove = React.useCallback((optionValue: string, e: React.MouseEvent) => {\n      e.stopPropagation();\n      const newValue = value.filter((v) => v !== optionValue);\n      onValueChange?.(newValue);\n    }, [value, onValueChange]);\n\n    const handleClear = React.useCallback((e: React.MouseEvent) => {\n      e.stopPropagation();\n      onValueChange?.([]);\n    }, [onValueChange]);\n\n    const displayValue = React.useMemo(() => {\n      if (selectedOptions.length === 0) return placeholder;\n      if (selectedOptions.length <= maxCount) {\n        return selectedOptions.map((opt) => opt.label).join(\", \");\n      }\n      return `${selectedOptions.slice(0, maxCount).map((opt) => opt.label).join(\", \")} +${selectedOptions.length - maxCount} more`;\n    }, [selectedOptions, maxCount, placeholder]);\n\n\n    return (\n      <Popover open={open} onOpenChange={setOpen} modal={false}>\n        <PopoverTrigger asChild>\n          <Button\n            ref={ref}\n            variant=\"outline\"\n            role=\"combobox\"\n            aria-expanded={open}\n            aria-label={selectedOptions.length > 0 \n              ? `Selected ${selectedOptions.length} option${selectedOptions.length > 1 ? 's' : ''}: ${selectedOptions.map(opt => opt.label).join(', ')}`\n              : placeholder || \"Select options\"}\n            aria-haspopup=\"listbox\"\n            className={clsx(\n              \"w-full justify-between min-h-10 h-auto\",\n              selectedOptions.length > 0 && \"px-2 py-1.5\",\n              className\n            )}\n            disabled={disabled}\n          >\n            <div className=\"flex flex-wrap gap-[var(--space-1)] flex-1 text-left\">\n              {selectedOptions.length === 0 ? (\n                <span className=\"text-[color:var(--color-fg-muted)]\">\n                  {placeholder}\n                </span>\n              ) : (\n                <>\n                  {selectedOptions.slice(0, maxCount).map((option) => (\n                    <span\n                      key={option.value}\n                      className=\"inline-flex items-center gap-[var(--space-1)] px-[var(--space-2)] py-[var(--space-1)] rounded-[var(--radius-sm)] bg-[color:var(--color-surface-2)] text-sm\"\n                    >\n                      {option.label}\n                      {clearable && (\n                        <span\n                          role=\"button\"\n                          tabIndex={0}\n                          onClick={(e) => handleRemove(option.value, e)}\n                          onKeyDown={(e) => {\n                            if (e.key === \"Enter\" || e.key === \" \") {\n                              e.preventDefault();\n                              handleRemove(option.value, e as any);\n                            }\n                          }}\n                          className=\"ml-[var(--space-1)] hover:bg-[color:var(--color-surface-3)] rounded p-[var(--space-1)] cursor-pointer\"\n                          aria-label={`Remove ${option.label}`}\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </span>\n                      )}\n                    </span>\n                  ))}\n                  {selectedOptions.length > maxCount && (\n                    <span className=\"text-sm text-[color:var(--color-fg-muted)]\">\n                      +{selectedOptions.length - maxCount} more\n                    </span>\n                  )}\n                </>\n              )}\n            </div>\n            <div className=\"flex items-center gap-[var(--space-1)] ml-[var(--space-2)]\">\n              {clearable && selectedOptions.length > 0 && (\n                <span\n                  role=\"button\"\n                  tabIndex={0}\n                  onClick={handleClear}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\" || e.key === \" \") {\n                      e.preventDefault();\n                      handleClear(e as any);\n                    }\n                  }}\n                  className=\"hover:bg-[color:var(--color-surface-2)] rounded p-[var(--space-1)] cursor-pointer\"\n                  aria-label=\"Clear all\"\n                >\n                  <X className=\"h-4 w-4\" />\n                </span>\n              )}\n              <span className=\"ml-[var(--space-1)]\">▼</span>\n            </div>\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent \n          className=\"w-full p-0\" \n          align=\"start\"\n          onEscapeKeyDown={() => {\n            setOpen(false);\n          }}\n        >\n          <CommandPrimitive \n            shouldFilter={false}\n            loop\n          >\n            <div className=\"flex items-center border-b px-[var(--space-3)]\">\n              <CommandPrimitive.Input\n                placeholder={searchPlaceholder}\n                value={search}\n                onValueChange={setSearch}\n                className=\"flex h-11 w-full rounded-[var(--radius-md)] bg-transparent py-[var(--space-3)] text-sm outline-none placeholder:text-[color:var(--color-fg-muted)] disabled:cursor-not-allowed disabled:opacity-50\"\n              />\n            </div>\n            {loading ? (\n              <div className=\"py-[var(--space-6)] text-center text-sm flex items-center justify-center gap-[var(--space-2)]\">\n                <Spinner className=\"h-4 w-4\" />\n                <span>Loading...</span>\n              </div>\n            ) : (\n              <CommandPrimitive.Empty className=\"py-[var(--space-6)] text-center text-sm\">\n                {emptyText}\n              </CommandPrimitive.Empty>\n            )}\n            <CommandPrimitive.Group>\n              <CommandPrimitive.List role=\"listbox\" aria-label=\"Options\">\n                {filteredOptions.map((option) => {\n                  const isSelected = value.includes(option.value);\n                  return (\n                    <div\n                      key={option.value}\n                      role=\"option\"\n                      aria-selected={isSelected}\n                      onClick={(e) => {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        if (!option.disabled) {\n                          handleSelect(option.value);\n                        }\n                      }}\n                      onKeyDown={(e) => {\n                        if (e.key === \"Enter\" || e.key === \" \") {\n                          e.preventDefault();\n                          if (!option.disabled) {\n                            handleSelect(option.value);\n                          }\n                        }\n                      }}\n                      tabIndex={option.disabled ? -1 : 0}\n                      className={clsx(\n                        \"relative flex cursor-pointer select-none items-center rounded-[var(--radius-sm)] px-[var(--space-2)] py-[var(--space-1-5)] text-sm outline-none hover:bg-[color:var(--color-surface-2)]\",\n                        isSelected && \"bg-[color:var(--color-surface-2)]\",\n                        option.disabled && \"opacity-50 cursor-not-allowed pointer-events-none\"\n                      )}\n                    >\n                      <div className=\"flex items-center gap-[var(--space-2)] flex-1 w-full\">\n                        <div\n                          className={clsx(\n                            \"h-4 w-4 rounded border flex items-center justify-center flex-shrink-0\",\n                            isSelected\n                              ? \"bg-brand border-brand\"\n                              : \"border-[color:var(--color-fg-muted)]\"\n                          )}\n                        >\n                          {isSelected && (\n                            <span className=\"text-white text-xs\">✓</span>\n                          )}\n                        </div>\n                        <span className=\"flex-1\">{option.label}</span>\n                      </div>\n                    </div>\n                  );\n                })}\n              </CommandPrimitive.List>\n            </CommandPrimitive.Group>\n          </CommandPrimitive>\n        </PopoverContent>\n      </Popover>\n    );\n  }\n);\n\n"
    }
  ]
}